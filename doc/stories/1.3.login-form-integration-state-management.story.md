# Story 1.3: Login Form Integration and State Management

## Status
Draft

## Story

**As a** end user,
**I want** to log in with real credentials through the existing login form that connects to real authentication services,
**so that** I can access the application with secure JWT-based authentication while maintaining the same familiar user experience.

## Acceptance Criteria

1. Fake authentication delay (`Future.delayed(2 seconds)`) is removed from login form
2. AuthBloc is created following existing BLoC patterns with proper state management  
3. Login form integrates with AuthBloc instead of fake authentication logic
4. Loading states, success states, and error handling are properly implemented in the UI
5. Successful login stores JWT tokens and navigates to main application area
6. Login failures display appropriate error messages without breaking existing UI patterns
7. Automatic token refresh is implemented to handle token expiry transparently
8. Logout functionality clears tokens and returns user to login screen
9. All existing UI components and user experience are preserved exactly as before

## Tasks / Subtasks

### Remove Fake Authentication Logic (AC: 1)
- [ ] Update existing login form to remove fake authentication
  - [ ] Edit `lib/features/authentication/presentation/widgets/login_form.dart`
  - [ ] Remove `await Future<void>.delayed(const Duration(seconds: 2));` from line 285
  - [ ] Remove fake authentication success logic
  - [ ] Keep all existing UI components, validation, and styling exactly as is
  - [ ] Preserve error handling UI structure for real error integration

### AuthBloc State Management Implementation (AC: 2, 7, 8)
- [ ] Create authentication BLoC with comprehensive state management
  - [ ] Implement `lib/features/authentication/application/blocs/auth_bloc.dart`
    - [ ] Create AuthState sealed class with: initial, loading, authenticated, unauthenticated, error variants
    - [ ] Create AuthEvent sealed class with: loginRequested, logoutRequested, tokenRefreshRequested, authCheckRequested
    - [ ] Inject AuthRepository and LoginUseCase dependencies via constructor
    - [ ] Implement event handlers using existing repository methods
  - [ ] Implement authentication state persistence
    - [ ] Create `lib/features/authentication/application/blocs/auth_state.dart` 
    - [ ] Use sealed classes with Freezed: AuthState.initial(), AuthState.loading(), AuthState.authenticated(UserEntity user), AuthState.unauthenticated(), AuthState.error(String message)
    - [ ] Add JSON serialization for HydratedBloc persistence if needed
  - [ ] Implement authentication events
    - [ ] Create `lib/features/authentication/application/blocs/auth_event.dart`
    - [ ] Use sealed classes: LoginRequested(username, password, rememberMe), LogoutRequested(), TokenRefreshRequested(), AuthCheckRequested()
  - [ ] Configure BLoC with dependency injection
    - [ ] Register AuthBloc with @injectable annotation
    - [ ] Ensure proper disposal and lifecycle management

### Login Form Integration with Real Authentication (AC: 3, 4, 5, 6, 9)
- [ ] Integrate login form with AuthBloc
  - [ ] Update `lib/features/authentication/presentation/widgets/login_form.dart`
    - [ ] Inject AuthBloc via BlocProvider or GetIt dependency injection
    - [ ] Replace fake authentication logic in `_handleLogin()` method
    - [ ] Dispatch LoginRequested event with form data (username, password, rememberMe: false)
    - [ ] Preserve all existing form validation logic exactly as is
    - [ ] Keep all existing UI animations, styling, and visual behavior
  - [ ] Implement BlocListener for state-based side effects
    - [ ] Listen for AuthState.authenticated to navigate to main app area
    - [ ] Listen for AuthState.error to update form error display
    - [ ] Use existing error display mechanisms (preserve `_usernameError`, `_passwordError` patterns)
  - [ ] Implement BlocBuilder for loading state integration
    - [ ] Connect AuthState.loading to existing `_isLoading` boolean
    - [ ] Preserve existing loading button animation and disabled state
    - [ ] Keep existing CircularProgressIndicator styling and behavior
  - [ ] Implement error message integration
    - [ ] Map AuthFailure types to user-friendly error messages
    - [ ] Display errors using existing `_buildErrorText` mechanism
    - [ ] Handle network errors with user-appropriate messages
    - [ ] Handle credential errors by highlighting username/password fields

### Navigation Integration (AC: 5, 9)
- [ ] Implement post-authentication navigation
  - [ ] Update login success flow to navigate to main application
  - [ ] Use existing navigation patterns (auto_route if configured)
  - [ ] Ensure navigation replaces login screen (no back navigation to login after success)
  - [ ] Preserve any existing navigation animations or transitions
- [ ] Maintain existing navigation structure
  - [ ] Keep login page as entry point for unauthenticated users
  - [ ] Ensure proper integration with existing routing configuration
  - [ ] Verify no breaking changes to existing navigation flows

### Token Management and Auto-Refresh (AC: 7, 8)
- [ ] Implement automatic token refresh functionality
  - [ ] Add token expiry monitoring in AuthBloc
  - [ ] Create background token refresh when tokens are close to expiry
  - [ ] Handle refresh token expiry by logging user out gracefully
  - [ ] Ensure seamless user experience during token refresh (no visible UI changes)
- [ ] Implement logout functionality
  - [ ] Add logout capability to AuthBloc (LogoutRequested event)
  - [ ] Clear all stored tokens via repository logout method
  - [ ] Reset authentication state to unauthenticated
  - [ ] Navigate back to login screen on logout
  - [ ] Clear any cached user data or sensitive information

### Application Startup Authentication Check (AC: 7)
- [ ] Implement app startup authentication verification
  - [ ] Add authentication check during app initialization
  - [ ] Check for existing valid tokens in secure storage
  - [ ] Automatically authenticate user if valid tokens exist
  - [ ] Handle expired tokens by prompting for re-authentication
  - [ ] Integrate with existing app bootstrap process
- [ ] Handle authentication state persistence
  - [ ] Restore authentication state on app restart
  - [ ] Handle token expiry during app inactivity
  - [ ] Maintain security by re-validating tokens on app foreground

### Testing and Validation (AC: 9)
- [ ] Create comprehensive tests for authentication flow
  - [ ] Test `test/features/authentication/application/blocs/auth_bloc_test.dart`
    - [ ] Test all state transitions (initial → loading → authenticated/unauthenticated)
    - [ ] Test error state handling for various failure scenarios
    - [ ] Test token refresh functionality
    - [ ] Test logout functionality
    - [ ] Mock AuthRepository for isolated BLoC testing
  - [ ] Test `test/features/authentication/presentation/widgets/login_form_test.dart`
    - [ ] Test integration with AuthBloc
    - [ ] Test form submission with real authentication
    - [ ] Test loading state display
    - [ ] Test error message display
    - [ ] Verify existing UI behavior is preserved
  - [ ] Integration test for complete authentication flow
    - [ ] Test end-to-end login → authentication → navigation flow
    - [ ] Test logout → return to login flow
    - [ ] Test error scenarios and recovery
- [ ] Verify existing UI preservation
  - [ ] Visual regression testing to ensure no UI changes
  - [ ] Test all existing form animations and transitions
  - [ ] Verify accessibility features are maintained
  - [ ] Test responsive design behavior is unchanged

## Dev Notes

### Previous Story Insights
**From Story 1.1** [Assumed Complete]:
- Domain entities (UserEntity, TokenEntity, AuthFailure) are available
- JWT service and SecureStorageService are implemented
- Basic Chopper HTTP client is configured

**From Story 1.2** [Assumed Complete]:
- AuthRepository with real API integration is implemented
- Authentication API service with login/logout/refresh is available
- Mappers between API models and domain entities are working
- Error handling is implemented with AuthFailure mapping

### Technical Architecture Context

**Existing Login Form Analysis** [Source: lib/features/authentication/presentation/widgets/login_form.dart]:
- **Current Implementation**: Line 285 contains `await Future<void>.delayed(const Duration(seconds: 2));` - this must be removed
- **Form Structure**: Uses `_formKey`, `_usernameController`, `_passwordController` with proper validation
- **Loading State**: `_isLoading` boolean controls loading button state and CircularProgressIndicator
- **Error Display**: `_usernameError`, `_passwordError` strings with `_buildErrorText()` method
- **UI Components**: Animated text fields, custom button, proper styling - all must be preserved
- **Navigation**: Currently commented out navigation to MainWrapperRoute - needs real implementation

**BLoC Pattern Implementation** [Source: Existing Codebase Patterns]:
- **State Management**: Uses flutter_bloc, hydrated_bloc for persistence
- **Dependency Injection**: BLoCs registered with @injectable and accessed via GetIt or BlocProvider
- **Event-Driven**: Events trigger state transitions, UI listens to states via BlocListener and BlocBuilder
- **Error Handling**: States contain error information, UI displays appropriately

**BLoC Integration Patterns** [Source: Existing Project Architecture]:
- **State Classes**: Use sealed classes with Freezed for type-safe state variants
- **Event Classes**: Use sealed classes for type-safe event handling
- **Repository Integration**: Inject repositories into BLoCs, call methods in event handlers
- **Either Pattern**: Handle repository Either<Failure, Success> returns in BLoC event handlers

**Navigation Integration** [Source: lib/core/guards/auth_guard.dart and auto_route setup]:
- **Auto Route**: Uses auto_route for type-safe navigation
- **Auth Guard**: Existing auth guard checks authentication state
- **Route Protection**: Authenticated routes require valid authentication state
- **Navigation Context**: Use context.router for navigation operations

**File Locations** [Source: Project Structure Analysis]:
- **Application Layer**: `lib/features/authentication/application/blocs/`
- **Presentation Integration**: Update existing `lib/features/authentication/presentation/widgets/login_form.dart`
- **BLoC Tests**: `test/features/authentication/application/blocs/`
- **Widget Tests**: `test/features/authentication/presentation/widgets/`

**State Persistence** [Source: pubspec.yaml hydrated_bloc dependency]:
- **HydratedBloc**: Can be used to persist authentication state across app restarts
- **Secure Storage**: JWT tokens should remain in SecureStorageService, not in BLoC state
- **State Restoration**: Authentication state can be restored from stored tokens

### Integration Points

**Existing Form Validation** [Source: login_form.dart analysis]:
- **Username Validation**: `_validateUsername()` - minimum 3 characters, not empty
- **Password Validation**: `_validatePassword()` - minimum 6 characters, not empty  
- **Error States**: `_hasSubmitted` controls error display timing
- **Form Submission**: `_handleLogin()` method currently contains fake authentication

**UI State Management** [Source: login_form.dart analysis]:
- **Loading State**: `_isLoading` boolean controls button and progress indicator
- **Animation Controllers**: Border animations for focus states
- **Form Controllers**: Text controllers for username and password input
- **Responsive Design**: `_getResponsiveSpacing()` method for screen adaptation

**Error Handling Integration**:
- **AuthFailure Mapping**: Map domain failures to user-friendly error messages
- **Network Errors**: "Unable to connect. Please check your internet connection."
- **Invalid Credentials**: "Invalid username or password. Please try again."
- **Server Errors**: "Service temporarily unavailable. Please try again later."
- **Form Field Errors**: Display field-specific errors using existing error display mechanism

### Testing Standards

**Test File Locations**:
- BLoC tests: `test/features/authentication/application/blocs/`
- Widget tests: `test/features/authentication/presentation/widgets/`
- Integration tests: `test/integration/authentication_flow_test.dart`

**Testing Frameworks** [Source: pubspec.yaml]:
- **BLoC Testing**: Use `bloc_test` package for BLoC unit tests
- **Widget Testing**: Use `flutter_test` for form integration tests
- **Mocking**: Use `mocktail` for repository and navigation mocking

**Critical Testing Requirements**:
- **BLoC State Transitions**: Test all event → state transitions
- **Error State Handling**: Test how different AuthFailure types are handled
- **Form Integration**: Test that form submission triggers correct BLoC events
- **Navigation**: Test successful login navigation and logout return to login
- **UI Preservation**: Verify existing form behavior is maintained
- **Token Refresh**: Test automatic token refresh functionality
- **Startup Auth Check**: Test app startup authentication verification

**Testing Strategy**:
- **Unit Tests**: BLoC in isolation with mocked repository
- **Widget Tests**: Login form with mocked BLoC
- **Integration Tests**: Complete authentication flow end-to-end
- **Visual Regression**: Ensure no unintended UI changes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-20 | 1.0 | Initial story creation based on Epic requirements and Stories 1.1-1.2 context | Story Manager |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review of the completed story implementation*